<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Farmacia Iglesia – Reconocimiento de Medicinas</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React UMD (compatible con GitHub Pages) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

  <!-- Gemini API -->
  <script type="module" src="https://unpkg.com/@google/generative-ai/dist/index.js"></script>

  <style>
    .btn {
      @apply bg-blue-600 text-white px-4 py-2 rounded mb-2;
    }
  </style>
</head>

<body class="p-4">
  <div id="root"></div>

  <script type="module">
    /* ---------------------------------------------------------
       Imports desde UMD
    --------------------------------------------------------- */
    const { useState, useEffect, useRef } = React;

    /* ---------------------------------------------------------
       Firebase Config (Pega tus claves aquí)
    --------------------------------------------------------- */
    const firebaseConfig = {
       apiKey: "AIzaSyDVI2gA-Q_leXM74lbCErJneV3h-Xs_V5k",
       authDomain: "farmacia-iglesia.firebaseapp.com",
       projectId: "farmacia-iglesia",
       storageBucket: "farmacia-iglesia.firebasestorage.app",
       messagingSenderId: "892807551500",
       appId: "1:892807551500:web:935b4cc0bcf1dc97d1ec29",
       measurementId: "G-HE7RWNXSY5"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ---------------------------------------------------------
       Gemini API
    --------------------------------------------------------- */
    import { GoogleGenerativeAI } from "https://unpkg.com/@google/generative-ai/dist/index.js";

    const genAI = new GoogleGenerativeAI("AIzaSyBYI5l5GmvXZczc2_d93YeSNWBGdaVU5_8");
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

    /* ---------------------------------------------------------
       Cámara
    --------------------------------------------------------- */
    async function startCamera(videoRef) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        videoRef.srcObject = stream;
      } catch (e) {
        console.warn("No se pudo acceder a la cámara");
      }
    }

    function captureImage(videoRef) {
      const canvas = document.createElement("canvas");
      canvas.width = videoRef.videoWidth;
      canvas.height = videoRef.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(videoRef, 0, 0);
      return new Promise(resolve => {
        canvas.toBlob(blob => resolve(blob), "image/jpeg");
      });
    }

    /* ---------------------------------------------------------
       OCR con múltiples imágenes
    --------------------------------------------------------- */
    async function processImagesWithAI(files, prompt) {
      const buffers = await Promise.all([...files].map(f => f.arrayBuffer()));

      const result = await model.generateContent([
        prompt,
        ...buffers.map(b => ({
          inlineData: { data: b, mimeType: "image/jpeg" }
        }))
      ]);

      return result.response.text();
    }

    /* ---------------------------------------------------------
       Firestore
    --------------------------------------------------------- */
    async function addMedicine(data) {
      await db.collection("medicinas").add(data);
    }

    async function deleteMedicineByName(nombre) {
      const snap = await db.collection("medicinas").where("nombre", "==", nombre).get();
      snap.forEach(d => d.ref.delete());
    }

    /* ---------------------------------------------------------
       Navegación interna
    --------------------------------------------------------- */
    function useNavigation() {
      const [screen, setScreen] = useState("menu");

      useEffect(() => {
        history.pushState({ screen }, "");
      }, [screen]);

      useEffect(() => {
        window.onpopstate = e => {
          const s = e.state?.screen || "menu";
          setScreen(s);
        };
      }, []);

      return [screen, setScreen];
    }

    /* ---------------------------------------------------------
       App principal
    --------------------------------------------------------- */
    function App() {
      const [screen, setScreen] = useNavigation();

      const regInputRef = useRef();
      const regVideoRef = useRef();

      const delInputRef = useRef();
      const delVideoRef = useRef();

      const [regOutput, setRegOutput] = useState("");
      const [delOutput, setDelOutput] = useState("");

      useEffect(() => {
        if (screen === "registrar") startCamera(regVideoRef.current);
        if (screen === "eliminar") startCamera(delVideoRef.current);
      }, [screen]);

      async function handleCapture(type) {
        const video = type === "reg" ? regVideoRef.current : delVideoRef.current;
        const input = type === "reg" ? regInputRef.current : delInputRef.current;

        const blob = await captureImage(video);
        const file = new File([blob], "captura.jpg", { type: "image/jpeg" });

        const dt = new DataTransfer();
        [...input.files].forEach(f => dt.items.add(f));
        dt.items.add(file);
        input.files = dt.files;
      }

      async function procesarRegistro() {
        const files = regInputRef.current.files;
        if (!files.length) return alert("Sube o captura imágenes");

        const text = await processImagesWithAI(
          files,
          "Extrae toda la información posible de estas medicinas. Devuelve JSON limpio."
        );

        setRegOutput(text);

        try {
          const data = JSON.parse(text);
          await addMedicine(data);
        } catch {
          console.warn("No se pudo guardar en Firestore");
        }
      }

      async function procesarEliminacion() {
        const files = delInputRef.current.files;
        if (!files.length) return alert("Sube o captura imágenes");

        const text = await processImagesWithAI(
          files,
          "Identifica el nombre de esta medicina para eliminarla. Devuelve solo el nombre."
        );

        setDelOutput(text);
        await deleteMedicineByName(text.trim());
      }

      /* ---------------------------------------------------------
         Render
      --------------------------------------------------------- */
      return (
        <div>
          {screen === "menu" && (
            <div className="flex flex-col gap-4">
              <button className="btn" onClick={() => setScreen("registrar")}>
                Registrar Medicina
              </button>
              <button className="btn" onClick={() => setScreen("eliminar")}>
                Eliminar Medicina
              </button>
            </div>
          )}

          {screen === "registrar" && (
            <div>
              <h2 className="text-xl font-bold mb-4">Registrar Medicina</h2>

              <input type="file" multiple accept="image/*" ref={regInputRef} className="mb-4" />

              <video ref={regVideoRef} width="300" autoPlay playsInline></video>
              <button className="btn" onClick={() => handleCapture("reg")}>Capturar</button>

              <button className="btn" onClick={procesarRegistro}>Procesar</button>

              <button className="btn" onClick={() => history.back()}>Atrás</button>

              <pre className="mt-4 whitespace-pre-wrap">{regOutput}</pre>
            </div>
          )}

          {screen === "eliminar" && (
            <div>
              <h2 className="text-xl font-bold mb-4">Eliminar Medicina</h2>

              <input type="file" multiple accept="image/*" ref={delInputRef} className="mb-4" />

              <video ref={delVideoRef} width="300" autoPlay playsInline></video>
              <button className="btn" onClick={() => handleCapture("del")}>Capturar</button>

              <button className="btn" onClick={procesarEliminacion}>Procesar</button>

              <button className="btn" onClick={() => history.back()}>Atrás</button>

              <pre className="mt-4 whitespace-pre-wrap">{delOutput}</pre>
            </div>
          )}
        </div>
      );
    }

    /* ---------------------------------------------------------
       Render final
    --------------------------------------------------------- */
    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
