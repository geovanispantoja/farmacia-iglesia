<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farmacia de la Iglesia - Sistema de Gesti√≥n</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, deleteDoc, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        window.firebaseModules = { initializeApp, getFirestore, collection, getDocs, addDoc, updateDoc, doc, deleteDoc, query, orderBy, limit };
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // Iconos SVG (simplificados)
        const Camera = () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>;
        const X = () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>;
        const Key = () => <svg className="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" /></svg>;
        const Loader = () => <svg className="w-full h-full animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" /></svg>;

        const TestApp = () => {
            const [showApiKeyModal, setShowApiKeyModal] = useState(false);
            const [geminiApiKey, setGeminiApiKey] = useState('');
            const [showWebcam, setShowWebcam] = useState(false);
            const [webcamStream, setWebcamStream] = useState(null);
            const [capturedImage, setCapturedImage] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [ocrResult, setOcrResult] = useState(null);
            const [apiError, setApiError] = useState('');

            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                const savedKey = localStorage.getItem('gemini_api_key_v2');
                if (savedKey) {
                    setGeminiApiKey(savedKey);
                } else {
                    setShowApiKeyModal(true);
                }
            }, []);

            const saveApiKey = () => {
                if (geminiApiKey && geminiApiKey.trim().startsWith('AIzaSy')) {
                    localStorage.setItem('gemini_api_key_v2', geminiApiKey.trim());
                    setShowApiKeyModal(false);
                    alert('‚úÖ API Key configurada correctamente');
                } else {
                    alert('‚ö†Ô∏è Por favor ingresa una API Key v√°lida de Google Gemini');
                }
            };

            const startWebcam = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'user', width: 1280, height: 720 } 
                    });
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                    }
                    setWebcamStream(stream);
                    setShowWebcam(true);
                } catch (error) {
                    console.error('Error accediendo a la webcam:', error);
                    alert('‚ö†Ô∏è No se pudo acceder a la webcam. Verifica los permisos del navegador.');
                }
            };

            const stopWebcam = () => {
                if (webcamStream) {
                    webcamStream.getTracks().forEach(track => track.stop());
                    setWebcamStream(null);
                }
                setShowWebcam(false);
            };

            const captureFromWebcam = () => {
                if (videoRef.current && canvasRef.current) {
                    const video = videoRef.current;
                    const canvas = canvasRef.current;
                    const context = canvas.getContext('2d');

                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;

                    context.translate(canvas.width, 0);
                    context.scale(-1, 1);
                    context.drawImage(video, 0, 0);

                    const imageData = canvas.toDataURL('image/jpeg', 0.9);
                    setCapturedImage(imageData);
                    processImageWithAI(imageData);
                    stopWebcam();
                }
            };

            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        setCapturedImage(event.target.result);
                        processImageWithAI(event.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const processImageWithAI = async (imageData) => {
                if (!geminiApiKey) {
                    alert('‚ö†Ô∏è Por favor configura tu API Key de Google Gemini primero');
                    setShowApiKeyModal(true);
                    return;
                }

                setIsProcessing(true);
                setApiError('');
                setOcrResult(null);

                // Lista de modelos para probar (en orden de preferencia)
                const modelsToTry = [
                    'gemini-1.5-flash',
                    'gemini-2.0-flash-exp',
                    'gemini-1.5-pro'
                ];

                for (const model of modelsToTry) {
                    try {
                        console.log(\`Intentando con modelo: \${model}\`);

                        const apiUrl = \`https://generativelanguage.googleapis.com/v1beta/models/\${model}:generateContent?key=\${geminiApiKey}\`;

                        const response = await fetch(apiUrl, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: "Analiza esta imagen de un medicamento y extrae: nombre, presentacion (tipo y dosis), categoria farmacologica. Responde SOLO con JSON: {\"nombre\":\"\",\"presentacion\":\"\",\"categoria\":\"\"}" },
                                        { inline_data: { mime_type: "image/jpeg", data: imageData.split(',')[1] } }
                                    ]
                                }]
                            })
                        });

                        const data = await response.json();

                        if (response.ok && data.candidates && data.candidates[0]) {
                            const text = data.candidates[0].content.parts[0].text.trim();
                            const cleanText = text.replace(/\`\`\`json|\`\`\`/g, '').trim();
                            const result = JSON.parse(cleanText);

                            setOcrResult({
                                ...result,
                                model: model,
                                success: true
                            });

                            setIsProcessing(false);
                            alert(\`‚úÖ Imagen analizada correctamente con \${model}\`);
                            return; // √âxito, salir del loop
                        } else {
                            // Error con este modelo, intentar el siguiente
                            console.warn(\`Modelo \${model} fall√≥:\`, data.error);
                            continue;
                        }
                    } catch (error) {
                        console.error(\`Error con modelo \${model}:\`, error);
                        continue;
                    }
                }

                // Si llegamos aqu√≠, ning√∫n modelo funcion√≥
                setApiError('‚ùå No se pudo analizar la imagen con ning√∫n modelo disponible. Verifica tu API Key o crea una nueva.');
                setIsProcessing(false);
                alert('‚ö†Ô∏è Error: No se pudo analizar la imagen. Por favor:\n\n1. Verifica que tu API Key sea correcta\n2. Crea una nueva API Key en: https://aistudio.google.com/app/apikey\n3. Aseg√∫rate de seleccionar "Create API key in new project"');
            };

            if (showApiKeyModal) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                            <div className="w-16 h-16 mx-auto mb-4 text-indigo-600"><Key /></div>
                            <h2 className="text-2xl font-bold text-center text-gray-800 mb-4">üîê Configuraci√≥n de API Key</h2>

                            <div className="bg-blue-50 border-2 border-blue-300 rounded-xl p-4 mb-6">
                                <p className="text-sm text-blue-800 mb-2"><strong>üìù C√≥mo obtener tu API Key:</strong></p>
                                <ol className="text-xs text-blue-700 space-y-1 ml-4 list-decimal">
                                    <li>Ve a: <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="underline hover:text-blue-900">aistudio.google.com/app/apikey</a></li>
                                    <li>Inicia sesi√≥n con tu cuenta de Google</li>
                                    <li>Click en "Create API Key"</li>
                                    <li><strong>IMPORTANTE:</strong> Selecciona "Create API key in new project"</li>
                                    <li>Copia la API Key completa</li>
                                    <li>P√©gala aqu√≠ abajo</li>
                                </ol>
                            </div>

                            <input
                                type="password"
                                value={geminiApiKey}
                                onChange={(e) => setGeminiApiKey(e.target.value)}
                                className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:outline-none mb-4"
                                placeholder="AIzaSy..."
                            />

                            <button
                                onClick={saveApiKey}
                                className="w-full bg-gradient-to-r from-indigo-500 to-indigo-600 text-white py-3 rounded-xl font-bold hover:shadow-lg transition-all"
                            >
                                üíæ Guardar y Continuar
                            </button>

                            <p className="text-xs text-gray-500 text-center mt-4">
                                üîí Tu API Key se guarda solo en tu navegador. Es 100% privada y segura.
                            </p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 p-4">
                    <div className="max-w-2xl mx-auto">
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <h1 className="text-3xl font-bold text-green-900 mb-2">üè• Farmacia de la Iglesia</h1>
                            <p className="text-gray-600">Prueba de Webcam + OCR con Gemini AI</p>
                            <button
                                onClick={() => setShowApiKeyModal(true)}
                                className="mt-2 text-xs text-gray-500 hover:text-gray-700 flex items-center"
                            >
                                <div className="w-4 h-4 mr-1"><Key /></div>
                                Cambiar API Key
                            </button>
                        </div>

                        <div className="bg-white rounded-2xl shadow-xl p-6">
                            <h2 className="text-2xl font-bold text-green-800 mb-6">üì∑ Capturar Medicamento</h2>

                            {!capturedImage && (
                                <div className="space-y-3">
                                    <input
                                        type="file"
                                        ref={fileInputRef}
                                        onChange={handleFileSelect}
                                        accept="image/*"
                                        className="hidden"
                                    />

                                    <button
                                        onClick={startWebcam}
                                        className="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-6 rounded-xl font-bold text-lg hover:shadow-lg transition-all"
                                    >
                                        üìπ Usar Webcam
                                    </button>

                                    <button
                                        onClick={() => fileInputRef.current.click()}
                                        className="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-6 rounded-xl font-bold text-lg hover:shadow-lg transition-all"
                                    >
                                        üì∏ Seleccionar Imagen del Medicamento
                                    </button>

                                    <p className="text-sm text-gray-600 text-center">
                                        La IA extraer√° autom√°ticamente la informaci√≥n del medicamento
                                    </p>
                                </div>
                            )}

                            {capturedImage && (
                                <div className="space-y-4">
                                    <img src={capturedImage} alt="Medicamento" className="w-full rounded-xl shadow-lg" />

                                    {isProcessing && (
                                        <div className="bg-blue-50 border-2 border-blue-300 rounded-xl p-4 text-center">
                                            <div className="w-8 h-8 mx-auto mb-2"><Loader /></div>
                                            <p className="text-blue-800 font-semibold">Analizando imagen con IA...</p>
                                            <p className="text-xs text-blue-600 mt-1">Probando m√∫ltiples modelos...</p>
                                        </div>
                                    )}

                                    {apiError && (
                                        <div className="bg-red-50 border-2 border-red-300 rounded-xl p-4">
                                            <p className="text-red-800 font-semibold">{apiError}</p>
                                        </div>
                                    )}

                                    {ocrResult && ocrResult.success && (
                                        <div className="bg-green-50 border-2 border-green-300 rounded-xl p-4">
                                            <p className="text-green-800 font-bold mb-2">‚úÖ An√°lisis Exitoso</p>
                                            <p className="text-sm text-green-700"><strong>Modelo usado:</strong> {ocrResult.model}</p>
                                            <p className="text-sm text-green-700"><strong>Nombre:</strong> {ocrResult.nombre}</p>
                                            <p className="text-sm text-green-700"><strong>Presentaci√≥n:</strong> {ocrResult.presentacion}</p>
                                            <p className="text-sm text-green-700"><strong>Categor√≠a:</strong> {ocrResult.categoria}</p>
                                        </div>
                                    )}

                                    <button
                                        onClick={() => {
                                            setCapturedImage(null);
                                            setOcrResult(null);
                                            setApiError('');
                                        }}
                                        className="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-all"
                                    >
                                        üîÑ Tomar otra foto
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>

                    {showWebcam && (
                        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-2xl w-full">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold text-gray-800">üìπ Capturar Foto del Medicamento</h3>
                                    <button onClick={stopWebcam} className="text-gray-500 hover:text-gray-700">
                                        <div className="w-6 h-6"><X /></div>
                                    </button>
                                </div>

                                <div className="relative bg-black rounded-xl overflow-hidden">
                                    <video 
                                        ref={videoRef} 
                                        autoPlay 
                                        playsInline
                                        className="w-full"
                                        style={{ transform: 'scaleX(-1)' }}
                                    />
                                    <canvas ref={canvasRef} className="hidden" />
                                </div>

                                <button
                                    onClick={captureFromWebcam}
                                    className="w-full mt-4 bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transition-all"
                                >
                                    üì∏ Capturar Foto
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<TestApp />, document.getElementById('root'));
    </script>
</body>
</html>
