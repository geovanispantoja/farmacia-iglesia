<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Farmacia Iglesia – Reconocimiento de Medicinas</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React moderno -->
  <script type="module">
    import React from "https://esm.sh/react";
    import ReactDOM from "https://esm.sh/react-dom/client";

    /* ---------------------------------------------------------
       Firebase
    --------------------------------------------------------- */
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

    import {
      getFirestore,
      collection,
      addDoc,
      deleteDoc,
      getDocs,
      query,
      where,
      doc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_AUTH_DOMAIN",
      projectId: "TU_PROJECT_ID",
      storageBucket: "TU_BUCKET",
      messagingSenderId: "TU_SENDER",
      appId: "TU_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ---------------------------------------------------------
       Gemini API (OCR mejorado)
    --------------------------------------------------------- */
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    const genAI = new GoogleGenerativeAI("TU_API_KEY_GEMINI");
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

    /* ---------------------------------------------------------
       Módulo: Cámara
    --------------------------------------------------------- */
    async function startCamera(videoRef) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        videoRef.srcObject = stream;
      } catch (e) {
        console.warn("No hay cámara disponible");
      }
    }

    function captureImage(videoRef) {
      const canvas = document.createElement("canvas");
      canvas.width = videoRef.videoWidth;
      canvas.height = videoRef.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(videoRef, 0, 0);
      return new Promise(resolve => {
        canvas.toBlob(blob => resolve(blob), "image/jpeg");
      });
    }

    /* ---------------------------------------------------------
       Módulo: OCR con múltiples imágenes
    --------------------------------------------------------- */
    async function processImagesWithAI(files, prompt) {
      const buffers = await Promise.all([...files].map(f => f.arrayBuffer()));

      const result = await model.generateContent([
        prompt,
        ...buffers.map(b => ({
          inlineData: { data: b, mimeType: "image/jpeg" }
        }))
      ]);

      return result.response.text();
    }

    /* ---------------------------------------------------------
       Módulo: Inventario (Firestore)
    --------------------------------------------------------- */
    async function addMedicine(data) {
      await addDoc(collection(db, "medicinas"), data);
    }

    async function deleteMedicineByName(nombre) {
      const q = query(collection(db, "medicinas"), where("nombre", "==", nombre));
      const snap = await getDocs(q);
      snap.forEach(d => deleteDoc(doc(db, "medicinas", d.id)));
    }

    /* ---------------------------------------------------------
       Navegación interna (N1)
    --------------------------------------------------------- */
    function useNavigation() {
      const [screen, setScreen] = React.useState("menu");

      React.useEffect(() => {
        history.pushState({ screen }, "");
      }, [screen]);

      React.useEffect(() => {
        window.onpopstate = e => {
          const s = e.state?.screen || "menu";
          setScreen(s);
        };
      }, []);

      return [screen, setScreen];
    }

    /* ---------------------------------------------------------
       Componente principal
    --------------------------------------------------------- */
    function App() {
      const [screen, setScreen] = useNavigation();

      const regInputRef = React.useRef();
      const regVideoRef = React.useRef();

      const delInputRef = React.useRef();
      const delVideoRef = React.useRef();

      const [regOutput, setRegOutput] = React.useState("");
      const [delOutput, setDelOutput] = React.useState("");

      React.useEffect(() => {
        if (screen === "registrar") startCamera(regVideoRef.current);
        if (screen === "eliminar") startCamera(delVideoRef.current);
      }, [screen]);

      async function handleCapture(type) {
        const video = type === "reg" ? regVideoRef.current : delVideoRef.current;
        const input = type === "reg" ? regInputRef.current : delInputRef.current;

        const blob = await captureImage(video);
        const file = new File([blob], "captura.jpg", { type: "image/jpeg" });

        const dt = new DataTransfer();
        [...input.files].forEach(f => dt.items.add(f));
        dt.items.add(file);
        input.files = dt.files;
      }

      async function procesarRegistro() {
        const files = regInputRef.current.files;
        if (!files.length) return alert("Sube o captura imágenes");

        const text = await processImagesWithAI(
          files,
          "Extrae toda la información posible de estas medicinas. Devuelve JSON limpio."
        );

        setRegOutput(text);

        try {
          const data = JSON.parse(text);
          await addMedicine(data);
        } catch {
          console.warn("No se pudo guardar en Firestore");
        }
      }

      async function procesarEliminacion() {
        const files = delInputRef.current.files;
        if (!files.length) return alert("Sube o captura imágenes");

        const text = await processImagesWithAI(
          files,
          "Identifica el nombre de esta medicina para eliminarla. Devuelve solo el nombre."
        );

        setDelOutput(text);
        await deleteMedicineByName(text.trim());
      }

      /* ---------------------------------------------------------
         Renderizado de pantallas
      --------------------------------------------------------- */
      return (
        <div className="p-4">
          {screen === "menu" && (
            <div className="flex flex-col gap-4">
              <button className="btn" onClick={() => setScreen("registrar")}>
                Registrar Medicina
              </button>
              <button className="btn" onClick={() => setScreen("eliminar")}>
                Eliminar Medicina
              </button>
            </div>
          )}

          {screen === "registrar" && (
            <div>
              <h2 className="text-xl font-bold mb-4">Registrar Medicina</h2>

              <input
                type="file"
                multiple
                accept="image/*"
                ref={regInputRef}
                className="mb-4"
              />

              <video ref={regVideoRef} width="300" autoPlay playsInline></video>
              <button className="btn" onClick={() => handleCapture("reg")}>
                Capturar
              </button>

              <button className="btn" onClick={procesarRegistro}>
                Procesar
              </button>

              <button className="btn" onClick={() => history.back()}>
                Atrás
              </button>

              <pre className="mt-4 whitespace-pre-wrap">{regOutput}</pre>
            </div>
          )}

          {screen === "eliminar" && (
            <div>
              <h2 className="text-xl font-bold mb-4">Eliminar Medicina</h2>

              <input
                type="file"
                multiple
                accept="image/*"
                ref={delInputRef}
                className="mb-4"
              />

              <video ref={delVideoRef} width="300" autoPlay playsInline></video>
              <button className="btn" onClick={() => handleCapture("del")}>
                Capturar
              </button>

              <button className="btn" onClick={procesarEliminacion}>
                Procesar
              </button>

              <button className="btn" onClick={() => history.back()}>
                Atrás
              </button>

              <pre className="mt-4 whitespace-pre-wrap">{delOutput}</pre>
            </div>
          )}
        </div>
      );
    }

    /* ---------------------------------------------------------
       Render
    --------------------------------------------------------- */
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>

  <style>
    .btn {
      @apply bg-blue-600 text-white px-4 py-2 rounded mb-2;
    }
  </style>
</head>

<body>
  <div id="root"></div>
</body>
</html>
