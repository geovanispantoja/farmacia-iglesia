<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Farmacia Iglesia</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React UMD -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Firebase compat v8 (NO modular) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    .btn { @apply bg-blue-600 text-white px-4 py-2 rounded mb-2; }
  </style>
</head>

<body class="p-4">
  <div id="root"></div>

  <script>
    const { useState, useEffect, useRef } = React;

    /* ---------------------------------------------------------
       Firebase (compat)
    --------------------------------------------------------- */
            const firebaseConfig = {
                apiKey: "AIzaSyDVI2gA-Q_leXM74lbCErJneV3h-Xs_V5k",
                authDomain: "farmacia-iglesia.firebaseapp.com",
                projectId: "farmacia-iglesia",
                storageBucket: "farmacia-iglesia.firebasestorage.app",
                messagingSenderId: "892807551500",
                appId: "1:892807551500:web:935b4cc0bcf1dc97d1ec29",
                measurementId: "G-HE7RWNXSY5"
            };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ---------------------------------------------------------
       Gemini API via fetch()
    --------------------------------------------------------- */
    const GEMINI_API_KEY = "AIzaSyBYI5l5GmvXZczc2_d93YeSNWBGdaVU5_8";

    async function geminiOCR(files, prompt) {
      const parts = [{ text: prompt }];

      for (const file of files) {
        const buffer = await file.arrayBuffer();
        const base64 = btoa(
          new Uint8Array(buffer).reduce((d, b) => d + String.fromCharCode(b), "")
        );

        parts.push({
          inlineData: {
            data: base64,
            mimeType: "image/jpeg"
          }
        });
      }

      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contents: [{ parts }] })
        }
      );

      const data = await response.json();
      return data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
    }

    /* ---------------------------------------------------------
       Cámara
    --------------------------------------------------------- */
    async function startCamera(video) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch {
        console.warn("No hay cámara disponible");
      }
    }

    async function captureImage(video) {
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0);

      return new Promise(resolve => {
        canvas.toBlob(blob => resolve(blob), "image/jpeg");
      });
    }

    /* ---------------------------------------------------------
       Firestore
    --------------------------------------------------------- */
    async function addMedicine(data) {
      await db.collection("medicinas").add(data);
    }

    async function deleteMedicineByName(nombre) {
      const snap = await db.collection("medicinas").where("nombre", "==", nombre).get();
      snap.forEach(d => d.ref.delete());
    }

    /* ---------------------------------------------------------
       Navegación interna
    --------------------------------------------------------- */
    function useNavigation() {
      const [screen, setScreen] = useState("menu");

      useEffect(() => {
        history.pushState({ screen }, "");
      }, [screen]);

      useEffect(() => {
        window.onpopstate = e => {
          const s = e.state?.screen || "menu";
          setScreen(s);
        };
      }, []);

      return [screen, setScreen];
    }

    /* ---------------------------------------------------------
       App principal
    --------------------------------------------------------- */
    function App() {
      const [screen, setScreen] = useNavigation();

      const regInput = useRef();
      const regVideo = useRef();
      const delInput = useRef();
      const delVideo = useRef();

      const [regOutput, setRegOutput] = useState("");
      const [delOutput, setDelOutput] = useState("");

      useEffect(() => {
        if (screen === "registrar") startCamera(regVideo.current);
        if (screen === "eliminar") startCamera(delVideo.current);
      }, [screen]);

      async function handleCapture(type) {
        const video = type === "reg" ? regVideo.current : delVideo.current;
        const input = type === "reg" ? regInput.current : delInput.current;

        const blob = await captureImage(video);
        const file = new File([blob], "captura.jpg", { type: "image/jpeg" });

        const dt = new DataTransfer();
        [...input.files].forEach(f => dt.items.add(f));
        dt.items.add(file);
        input.files = dt.files;
      }

      async function procesarRegistro() {
        const files = regInput.current.files;
        if (!files.length) return alert("Sube o captura imágenes");

        const text = await geminiOCR(
          files,
          "Extrae toda la información posible de estas medicinas. Devuelve JSON limpio."
        );

        setRegOutput(text);

        try {
          const data = JSON.parse(text);
          await addMedicine(data);
        } catch {
          console.warn("No se pudo guardar en Firestore");
        }
      }

      async function procesarEliminacion() {
        const files = delInput.current.files;
        if (!files.length) return alert("Sube o captura imágenes");

        const text = await geminiOCR(
          files,
          "Identifica el nombre de esta medicina para eliminarla. Devuelve solo el nombre."
        );

        setDelOutput(text);
        await deleteMedicineByName(text.trim());
      }

      return (
        React.createElement("div", null,
          screen === "menu" &&
            React.createElement("div", { className: "flex flex-col gap-4" },
              React.createElement("button", { className: "btn", onClick: () => setScreen("registrar") }, "Registrar Medicina"),
              React.createElement("button", { className: "btn", onClick: () => setScreen("eliminar") }, "Eliminar Medicina")
            ),

          screen === "registrar" &&
            React.createElement("div", null,
              React.createElement("h2", { className: "text-xl font-bold mb-4" }, "Registrar Medicina"),

              React.createElement("input", { type: "file", multiple: true, accept: "image/*", ref: regInput, className: "mb-4" }),

              React.createElement("video", { ref: regVideo, width: 300, autoPlay: true, playsInline: true }),
              React.createElement("button", { className: "btn", onClick: () => handleCapture("reg") }, "Capturar"),

              React.createElement("button", { className: "btn", onClick: procesarRegistro }, "Procesar"),
              React.createElement("button", { className: "btn", onClick: () => history.back() }, "Atrás"),

              React.createElement("pre", { className: "mt-4 whitespace-pre-wrap" }, regOutput)
            ),

          screen === "eliminar" &&
            React.createElement("div", null,
              React.createElement("h2", { className: "text-xl font-bold mb-4" }, "Eliminar Medicina"),

              React.createElement("input", { type: "file", multiple: true, accept: "image/*", ref: delInput, className: "mb-4" }),

              React.createElement("video", { ref: delVideo, width: 300, autoPlay: true, playsInline: true }),
              React.createElement("button", { className: "btn", onClick: () => handleCapture("del") }, "Capturar"),

              React.createElement("button", { className: "btn", onClick: procesarEliminacion }, "Procesar"),
              React.createElement("button", { className: "btn", onClick: () => history.back() }, "Atrás"),

              React.createElement("pre", { className: "mt-4 whitespace-pre-wrap" }, delOutput)
            )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
  </script>
</body>
</html>
